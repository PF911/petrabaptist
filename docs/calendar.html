<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Petra Baptist Church Events</title>

<style>
body{
  margin:0;
  padding:20px;
  font-family:Arial,sans-serif;
  background:linear-gradient(to bottom,#2e6aa9,#338cd0);
  color:white;
}
.container{max-width:600px;margin:0 auto;}
h1{text-align:center;margin-bottom:30px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
.loading{text-align:center;font-size:18px;padding:40px;}

.event{
  background:rgba(255,255,255,0.95);
  border-radius:12px;
  padding:20px;
  margin-bottom:15px;
  color:#333;
  box-shadow:0 3px 10px rgba(0,0,0,0.2);
}
.event-title{font-size:20px;font-weight:bold;color:#2e6aa9;margin-bottom:8px;}
.event-date{font-size:16px;color:#666;margin-bottom:5px;}
.event-time{font-size:14px;color:#888;}
.event-location{font-size:13px;color:#999;margin-top:5px;}
.event-description{margin-top:10px;font-size:14px;line-height:1.5;color:#555;}

.no-events{
  text-align:center;
  padding:40px;
  background:rgba(255,255,255,0.9);
  border-radius:12px;
  color:#666;
}
.error{
  background:rgba(255,100,100,0.9);
  color:white;
  padding:20px;
  border-radius:12px;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">
  <h1>üìÖ Petra Baptist Church Events</h1>
  <div id="calendar-content">
    <div class="loading">Loading upcoming events...</div>
  </div>
</div>

<script>
const CALENDAR_URL = 'https://p139-caldav.icloud.com/published/2/MTYxMTkzODk0MTYxMTkzOPujw-K55QjtelP7sq1DD8k2FbgbQgV1t2TTYXEYba2z1ssZCPG-AoxAtvInKXsOMdWExzB0u8n0H1O9aeDW39o';
const CORS_PROXY = 'https://corsproxy.io/?';

loadCalendar();

async function loadCalendar(){
  const content = document.getElementById('calendar-content');

  try{
    const response = await fetch(CORS_PROXY + encodeURIComponent(CALENDAR_URL));
    if(!response.ok) throw new Error('Fetch failed');

    const icsData = await response.text();
    let events = parseICS(icsData);

    if(events.length === 0){
      content.innerHTML = '<div class="no-events">No upcoming events at this time.</div>';
      return;
    }

    events.sort((a,b)=>a.start-b.start);

    content.innerHTML = events.map(e=>`
      <div class="event">
        <div class="event-title">${escapeHtml(e.summary)}</div>
        <div class="event-date">${formatDate(e.start)}</div>
        <div class="event-time">${formatTime(e.start,e.end)}</div>
        ${e.location?`<div class="event-location">üìç ${escapeHtml(e.location)}</div>`:''}
        ${e.description?`<div class="event-description">${escapeHtml(e.description)}</div>`:''}
      </div>
    `).join('');

  }catch(err){
    console.error(err);
    content.innerHTML = '<div class="error">Unable to load calendar events.</div>';
  }
}

function parseICS(ics){
  const events=[];
  const lines=ics.split(/\r?\n/);
  let ev=null;

  const today=new Date();
  today.setHours(0,0,0,0);
  const endRange=new Date(today);
  endRange.setDate(endRange.getDate()+60);

  for(const raw of lines){
    const line=raw.trim();

    if(line==='BEGIN:VEVENT'){ ev={}; continue; }
    if(line==='END:VEVENT'){
      if(ev.start){
        if(ev.rrule){
          events.push(...expandRecurring(ev,today,endRange));
        }else{
          const d=new Date(ev.start);
          d.setHours(0,0,0,0);
          if(d>=today && d<=endRange) events.push(ev);
        }
      }
      ev=null;
      continue;
    }
    if(!ev) continue;

    if(line.startsWith('SUMMARY:')) ev.summary=line.slice(8);
    else if(line.startsWith('DTSTART')) ev.start=parseICSDate(line);
    else if(line.startsWith('DTEND')) ev.end=parseICSDate(line);
    else if(line.startsWith('LOCATION:')) ev.location=line.slice(9).replace(/\\n/g,' ');
    else if(line.startsWith('DESCRIPTION:')) ev.description=line.slice(12);
    else if(line.startsWith('RRULE:')) ev.rrule=line.slice(6);
  }
  return events;
}

function e
