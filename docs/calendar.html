<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Petra Baptist Church Events</title>
<style>
body{margin:0;padding:20px;font-family:Arial,sans-serif;background:linear-gradient(to bottom,#2e6aa9,#338cd0);color:white;}
.container{max-width:600px;margin:0 auto;}
h1{text-align:center;margin-bottom:30px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
.loading{text-align:center;font-size:18px;padding:40px;}
.event{background:rgba(255,255,255,0.95);border-radius:12px;padding:20px;margin-bottom:15px;color:#333;box-shadow:0 3px 10px rgba(0,0,0,0.2);cursor:pointer;transition:transform 0.2s,box-shadow 0.2s;}
.event:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3);}
.event-title{font-size:20px;font-weight:bold;color:#2e6aa9;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;}
.event-date{font-size:16px;color:#666;margin-bottom:5px;}
.event-time{font-size:14px;color:#888;}
.event-location{font-size:13px;color:#999;margin-top:5px;}
.event-description{margin-top:10px;font-size:14px;line-height:1.5;color:#555;}
.event-details{max-height:0;overflow:hidden;transition:max-height 0.3s ease-out;}
.event-details.expanded{max-height:1000px;}
.expand-indicator{font-size:20px;color:#2e6aa9;transition:transform 0.3s;user-select:none;}
.expand-indicator.expanded{transform:rotate(180deg);}
.no-events{text-align:center;padding:40px;background:rgba(255,255,255,0.9);border-radius:12px;color:#666;}
.error{background:rgba(255,100,100,0.9);color:white;padding:20px;border-radius:12px;text-align:center;}
</style>
</head>
<body>
<div class="container">
  <h1>ðŸ“… Petra Baptist Church Events</h1>
  <div id="calendar-content">
    <div class="loading">Loading upcoming events...</div>
  </div>
</div>

<script>
const CALENDAR_URL='https://calendar.google.com/calendar/ical/c_7aa6dfe390e9df1454e5c362bf7c909b0b08e8bc8d4991d2f80028f69ef9ea67%40group.calendar.google.com/public/basic.ics';
const CORS_PROXY='https://api.allorigins.win/raw?url=';

async function loadCalendar(){
  const content=document.getElementById('calendar-content');
  try{
    const response = await fetch(CORS_PROXY + encodeURIComponent(CALENDAR_URL));
    
    if(!response.ok) throw new Error('Failed to fetch calendar: ' + response.status);
    const icsData=await response.text();

    const events=parseICS(icsData);
    if(events.length===0){
      content.innerHTML='<div class="no-events">No upcoming events at this time.</div>';
      return;
    }

    events.sort((a,b)=>a.start-b.start);
    displayEvents(events, content);

  }catch(error){
    console.error('Error loading calendar:',error);
    content.innerHTML='<div class="error">Unable to load calendar events.<br><small>' + error.message + '</small></div>';
  }
}

function displayEvents(events, content){
  const html = events.map((event, index) => {
    const title = (event.summary || 'Untitled Event').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const location = event.location ? event.location.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
    const description = event.description ? event.description.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
    
    return '<div class="event" onclick="toggleEvent(' + index + ')">' +
      '<div class="event-title">' +
        '<span>' + title + '</span>' +
        '<span class="expand-indicator" id="indicator-' + index + '">&#9660;</span>' +
      '</div>' +
      '<div class="event-date">' + formatDate(event.start) + '</div>' +
      '<div class="event-details" id="details-' + index + '">' +
        '<div class="event-time">' + formatTime(event.start, event.end) + '</div>' +
        (location ? '<div class="event-location">&#128205; ' + location + '</div>' : '') +
        (description ? '<div class="event-description">' + description + '</div>' : '') +
      '</div>' +
    '</div>';
  }).join('');
  
  content.innerHTML = html;
}

function parseICS(icsData){
  const events=[];
  const lines=icsData.split(/\r?\n/);
  let currentEvent=null;

  const today=new Date();
  today.setHours(0,0,0,0);
  const startRange=new Date(today);
  const sixtyDaysFromNow=new Date(today);
  sixtyDaysFromNow.setDate(sixtyDaysFromNow.getDate()+60);

  for(let i=0;i<lines.length;i++){
    const line=lines[i].trim();

    if(line==='BEGIN:VEVENT'){
      currentEvent={};
    }else if(line==='END:VEVENT' && currentEvent){
      if(currentEvent.start){
        if(currentEvent.rrule){
          const recurringEvents=expandRecurringEvent(currentEvent,startRange,sixtyDaysFromNow);
          events.push(...recurringEvents);
        }else{
          const eventDate=new Date(currentEvent.start);
          eventDate.setHours(0,0,0,0);
          if(eventDate>=startRange && eventDate<=sixtyDaysFromNow){
            events.push(currentEvent);
          }
        }
      }
      currentEvent=null;
    }else if(currentEvent){
      if(line.startsWith('SUMMARY:')){
        currentEvent.summary=line.substring(8).trim();
      }else if(line.startsWith('DTSTART')){
        currentEvent.start=parseICSDate(line);
      }else if(line.startsWith('DTEND')){
        currentEvent.end=parseICSDate(line);
      }else if(line.startsWith('LOCATION:')){
        currentEvent.location=line.substring(9).trim().replace(/\\n/g,' ').replace(/\\/g,'');
      }else if(line.startsWith('DESCRIPTION:')){
        currentEvent.description=line.substring(12).trim();
      }else if(line.startsWith('RRULE:')){
        currentEvent.rrule=line.substring(6).trim();
      }
    }
  }
  return events;
}

function expandRecurringEvent(event,startRange,endRange){
  const expanded=[];
  const rruleParts={};

  event.rrule.split(';').forEach(part=>{
    const [key,value]=part.split('=');
    rruleParts[key]=value;
  });

  if(rruleParts.FREQ==='WEEKLY'){
    const interval=parseInt(rruleParts.INTERVAL)||1;
    let untilDate=endRange;
    if(rruleParts.UNTIL) untilDate=parseICSDateString(rruleParts.UNTIL);

    let currentDate=new Date(event.start);

    while(currentDate<startRange && currentDate<=untilDate){
      currentDate.setDate(currentDate.getDate()+(7*interval));
    }

    let count=0;
    const maxCount=parseInt(rruleParts.COUNT)||100;

    while(currentDate<=untilDate && currentDate<=endRange && count<maxCount){
      if(currentDate>=startRange){
        const duration=event.end?event.end.getTime()-event.start.getTime():0;
        const newEnd=duration?new Date(currentDate.getTime()+duration):null;
        expanded.push({
          summary:event.summary,
          start:new Date(currentDate),
          end:newEnd,
          location:event.location,
          description:event.description
        });
      }
      currentDate.setDate(currentDate.getDate()+(7*interval));
      count++;
    }
  }

  return expanded;
}

function parseICSDateString(dateStr){
  if(dateStr.length>=8){
    const year=parseInt(dateStr.substring(0,4));
    const month=parseInt(dateStr.substring(4,6))-1;
    const day=parseInt(dateStr.substring(6,8));
    if(dateStr.length>8 && dateStr.includes('T')){
      const hour=parseInt(dateStr.substring(9,11));
      const minute=parseInt(dateStr.substring(11,13));
      if(dateStr.endsWith('Z')){
        return new Date(Date.UTC(year,month,day,hour,minute));
      }else{
        return new Date(year,month,day,hour,minute);
      }
    }
    return new Date(year,month,day);
  }
  return new Date();
}

function parseICSDate(line){
  const match=line.match(/[:;](\d{8})(T\d{6}Z?)?/);
  if(!match) return null;
  const dateStr=match[1];
  const timeStr=match[2];
  const year=parseInt(dateStr.substring(0,4));
  const month=parseInt(dateStr.substring(4,6))-1;
  const day=parseInt(dateStr.substring(6,8));
  if(timeStr){
    const hour=parseInt(timeStr.substring(1,3));
    const minute=parseInt(timeStr.substring(3,5));
    
    const hasTZID=line.includes('TZID=');
    const isUTC=timeStr.endsWith('Z');
    
    if(isUTC && !hasTZID){
      return new Date(Date.UTC(year,month,day,hour,minute));
    }else{
      return new Date(year,month,day,hour,minute);
    }
  }
  return new Date(year,month,day);
}

function formatDate(date){
  if(!date) return '';
  return date.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
}

function formatTime(start,end){
  if(!start) return 'All Day';
  const startTime=start.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
  if(!end) return startTime;
  const endTime=end.toLocaleTimeString('en-US',{hour:'numeric',minute:'2-digit',hour12:true});
  return startTime + ' - ' + endTime;
}

function toggleEvent(index){
  const details=document.getElementById('details-' + index);
  const indicator=document.getElementById('indicator-' + index);
  
  if(details && indicator){
    if(details.classList.contains('expanded')){
      details.classList.remove('expanded');
      indicator.classList.remove('expanded');
    }else{
      details.classList.add('expanded');
      indicator.classList.add('expanded');
    }
  }
}

loadCalendar();
</script>
</body>
</html>
